const express = require("express");
const bodyParser = require("body-parser");
const mongoose = require("mongoose");
const { verifySignature } = require("@ton-community/ton-crypto");

// اتصال به پایگاه داده MongoDB
mongoose.connect("mongodb://localhost:27017/tonGameDB", { useNewUrlParser: true, useUnifiedTopology: true });

const app = express();
app.use(bodyParser.json());

// مدل MongoDB برای ذخیره اطلاعات کیف پول
const WalletSchema = new mongoose.Schema({
  walletAddress: { type: String, required: true, unique: true },
  timestamp: { type: Date, default: Date.now },
});

const Wallet = mongoose.model("Wallet", WalletSchema);

// مسیر API برای ذخیره آدرس کیف پول
app.post("/api/save-wallet", async (req, res) => {
  const { walletAddress, signedMessage, message } = req.body;

  try {
    // تأیید امضای دیجیتال
    const isValid = verifySignature({
      publicKey: walletAddress,
      data: Buffer.from(message, "utf-8"),
      signature: Buffer.from(signedMessage, "base64"),
    });

    if (!isValid) {
      return res.status(400).json({ error: "Invalid signature!" });
    }

    // ذخیره آدرس کیف پول در پایگاه داده
    const wallet = new Wallet({ walletAddress });
    await wallet.save();

    res.status(200).json({ message: "Wallet saved successfully!" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: "Server error!" });
  }
});

// راه‌اندازی سرور
app.listen(3000, () => {
  console.log("Server is running on http://localhost:3000");
});
